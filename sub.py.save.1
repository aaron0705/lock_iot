import paho.mqtt.client as mqtt
from Crypto.Cipher import AES

key = "12345678901234567890123456789012"
iv = "1234567890123456"
topic = "pi/smarthome"

def aes_decrypt(cipher_text):
    cipher = AES.new(key, AES.MODE_CBC, iv)
    try:
        plain_text = cipher.decrypt(cipher_text)
    except ValueError:
        print("Unvalidate")

def on_connect(client, userdate, flags, rc):
    print("Connected with result code " + str(rc))
    client.subscribe(topic)

def on_message(client, userdata, message):
    message =  message.payload.decode()
    print("Message received: ", message)
    plain_text = aes_decrypt(message)
    print(f"Plain text is {plain_text}")

def main():
    broker = "piserver"
    port = 1883
    client = mqtt.Client()
    client.on_message = on_message
    client.on_connect = on_connect
    client.connect('localhost', 1883, 60)
    client.loop_forever()

if __name__ == "__main__":
    main()
