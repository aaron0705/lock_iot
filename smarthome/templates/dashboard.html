{% extends "index.html" %}

{% block header %}{% endblock %}

{# --- PHẦN 1: STYLE (CSS) - Đưa ra ngoài block content --- #}
{% block style %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. Cấu hình Layout chung --- */
        body {
            background-color: #f4f4f4;
            margin: 0;
            display: flex; /* Giúp sidebar và content nằm ngang hàng nhau (nếu cần) */
        }

        /* --- 2. Sidebar (Cố định bên trái) --- */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 60px; /* Thu nhỏ mặc định */
            background-color: #2c3e50;
            transition: width 0.3s;
            z-index: 1000;
            overflow: hidden;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        
        #sidebar:hover {
            width: 250px; /* Mở rộng khi hover */
        }

        .sidebar-header {
            color: white; padding: 15px; text-align: center; font-weight: bold; white-space: nowrap;
        }

        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-list li a {
            display: flex; align-items: center; padding: 15px; color: white; text-decoration: none;
            white-space: nowrap; /* Giữ chữ trên 1 dòng */
        }
        .menu-list li a:hover { background-color: #34495e; }
        .menu-list i { min-width: 30px; font-size: 20px; text-align: center; }
        .menu-list .text { margin-left: 10px; opacity: 0; transition: 0.2s; }
        #sidebar:hover .text { opacity: 1; }

        /* --- 3. Nội dung chính (Đẩy sang phải để tránh Sidebar) --- */
        .main-wrapper {
            margin-left: 80px; /* Cách lề trái để không bị Sidebar che */
            width: 100%;
            padding: 20px;
        }

        /* --- 4. Quote (Điều chỉnh lại để không chiếm hết màn hình) --- */
        #quote {
            display: flex;
            justify-content: center;
            align-items: center;
            /* height: 100vh;  <-- BỎ dòng này đi để không chiếm hết màn hình */
            padding: 20px 0;   /* Thêm padding thay vì fix height */
            background-color: transparent; 
        }
        #quote_text {
            font-family: 'Times New Roman', serif;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            align-items: center;
        }

        /* --- 5. Bản đồ (Map) --- */
        .map-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto; /* Căn giữa */
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        svg { width: 100%; height: auto; border: 1px dashed #ccc; }
        .wall { fill: none; stroke: #000; stroke-width: 5; stroke-linecap: round; }
        
        /* Thiết bị */
        .device-group { cursor: pointer; transition: transform 0.2s; }
        .device-group:hover { transform: scale(1.02); }
        .device-shape { fill: #fff; stroke: #000; stroke-width: 3; transition: 0.3s; }
        .device-text { font-size: 14px; font-weight: bold; fill: #333; pointer-events: none; text-anchor: middle; dominant-baseline: middle; }

        /* Active State */
        .device-group.active .device-shape { fill: #f1c40f; stroke: #f39c12; }
        #lock_door .device-shape {
            fill: #ffffff;      /* QUAN TRỌNG: Nền trắng đặc để che nét tường bên dưới */
            stroke: #e74c3c;    /* Viền màu Đỏ báo hiệu đang khóa */
            stroke-width: 4;    /* Viền dày hơn chút cho dễ nhìn */
            fill-opacity: 1;    /* SỬA LỖI: Đặt bằng 1 (không trong suốt) */
        }

        /* Trạng thái MỞ (ACTIVE/OPEN) */
        #lock_door.active .device-shape {
            fill: #dbfadd;      /* Nền xanh nhạt */
            stroke: #2ecc71;    /* Viền Xanh lá báo hiệu đã mở */
        }
        
        /* Chỉnh lại chữ cho dễ đọc */
        #lock_door text {
             font-weight: bold;
             fill: #c0392b; /* Chữ đỏ khi khóa */
        }
        #lock_door.active text {
             fill: #27ae60; /* Chữ xanh khi mở */
        }
    </style>
{% endblock %}

{# --- PHẦN 2: NỘI DUNG CHÍNH --- #}
{% block content %}
    
    <nav id="sidebar">
        <ul class="menu-list">
            <li><a href="{% url 'dashboard_app:dashboard' %}"><i class="fa-solid fa-house"></i><span class="text">Trang chủ</span></a></li>
            <li><a href="{% url 'device_control_app:device_control' %}"><i class="fa-solid fa-microchip"></i><span class="text">Thiết bị</span></a></li>
            <li><a href="{% url 'log_app:log_out' %}"><i class="fa-solid fa-right-from-bracket"></i><span class="text">Đăng xuất</span></a></li>
        </ul>
    </nav>

    <div class="main-wrapper">
        
        <div id="quote">
            <span id="quote_text">"Hành trình vạn dặm bắt đầu từ một bước đi"</span>
        </div>

        <div class="map-container">
            <svg viewBox="0 0 600 400">
                <rect x="50" y="20" width="500" height="360" rx="40" class="wall" />
                <path d="M 300 380 L 300 250 Q 300 220 330 220 L 550 220" class="wall" />

                <g id="led_1" class="device-group" onclick="toggleDevice('led_1')">
                    <rect x="70" y="60" width="80" height="100" rx="15" class="device-shape" />
                    <text x="110" y="110" class="device-text">led_1</text>
                </g>

                <g id="lock_door" class="device-group" onclick="toggleDevice('lock_door')">
                    <rect x="10" y="200" width="120" height="60" rx="20" class="device-shape" />
                    <text x="70" y="230" class="device-text">lock_door</text>
                </g>

                <g id="led_2" class="device-group" onclick="toggleDevice('led_2')">
                    <rect x="320" y="300" width="120" height="50" rx="15" class="device-shape" />
                    <text x="380" y="325" class="device-text">led_2</text>
                </g>
            </svg>
        </div>
    </div>

    {# --- PHẦN 3: JAVASCRIPT --- #}
    <script>
        function toggleDevice(deviceId) {
            // 1. Hiệu ứng giao diện (Frontend only)
            const element = document.getElementById(deviceId);
            element.classList.toggle('active');
            
            const isActive = element.classList.contains('active');
            console.log("Device:", deviceId, "Status:", isActive ? "ON" : "OFF");

            // 2. Gửi lệnh về Server (Cần bỏ comment khi bạn đã viết view xử lý)
            /*
            fetch(`/api/control/${deviceId}/`, {
                method: 'POST',
                body: JSON.stringify({status: isActive ? 'ON' : 'OFF'}),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Django yêu cầu cái này
                }
            });
            */
        }
    </script>

{% endblock %}